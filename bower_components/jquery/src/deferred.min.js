define(["./core","./var/slice","./callbacks"],function(e,t){return e.extend({Deferred:function(t){var n=[["resolve","done",e.Callbacks("once memory"),"resolved"],["reject","fail",e.Callbacks("once memory"),"rejected"],["notify","progress",e.Callbacks("memory")]],i="pending",r={state:function(){return i},always:function(){return s.done(arguments).fail(arguments),this},then:function(){var t=arguments;return e.Deferred(function(i){e.each(n,function(n,o){var a=e.isFunction(t[n])&&t[n];s[o[1]](function(){var t=a&&a.apply(this,arguments);t&&e.isFunction(t.promise)?t.promise().progress(i.notify).done(i.resolve).fail(i.reject):i[o[0]+"With"](this===r?i.promise():this,a?[t]:arguments)})}),t=null}).promise()},promise:function(t){return null!=t?e.extend(t,r):r}},s={};return r.pipe=r.then,e.each(n,function(e,t){var o=t[2],a=t[3];r[t[1]]=o.add,a&&o.add(function(){i=a},n[1^e][2].disable,n[2][2].lock),s[t[0]]=function(){return s[t[0]+"With"](this===s?r:this,arguments),this},s[t[0]+"With"]=o.fireWith}),r.promise(s),t&&t.call(s,s),s},when:function(n){var u,c,f,i=0,r=t.call(arguments),s=r.length,o=1!==s||n&&e.isFunction(n.promise)?s:0,a=1===o?n:e.Deferred(),l=function(e,n,i){return function(r){n[e]=this,i[e]=arguments.length>1?t.call(arguments):r,i===u?a.notifyWith(n,i):--o||a.resolveWith(n,i)}};if(s>1)for(u=new Array(s),c=new Array(s),f=new Array(s);s>i;i++)r[i]&&e.isFunction(r[i].promise)?r[i].promise().progress(l(i,c,u)).done(l(i,f,r)).fail(a.reject):--o;return o||a.resolveWith(f,r),a.promise()}}),e});