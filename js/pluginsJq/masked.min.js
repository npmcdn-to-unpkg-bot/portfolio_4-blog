!function(e){var t=(e.browser.msie?"paste":"input")+".mask",n=void 0!=window.orientation;e.mask={definitions:{9:"[0-9]",a:"[A-Za-z]","*":"[A-Za-z0-9]"},dataName:"rawMaskFn"},e.fn.extend({caret:function(e,t){if(0!=this.length){if("number"==typeof e)return t="number"==typeof t?t:e,this.each(function(){if(this.setSelectionRange)this.setSelectionRange(e,t);else if(this.createTextRange){var n=this.createTextRange();n.collapse(!0),n.moveEnd("character",t),n.moveStart("character",e),n.select()}});if(this[0].setSelectionRange)e=this[0].selectionStart,t=this[0].selectionEnd;else if(document.selection&&document.selection.createRange){var n=document.selection.createRange();e=0-n.duplicate().moveStart("character",-1e5),t=e+n.text.length}return{begin:e,end:t}}},unmask:function(){return this.trigger("unmask")},mask:function(r,i){if(!r&&this.length>0){var o=e(this[0]);return o.data(e.mask.dataName)()}i=e.extend({placeholder:"_",completed:null},i);var s=e.mask.definitions,a=[],u=r.length,l=null,f=r.length;return e.each(r.split(""),function(e,t){"?"==t?(f--,u=e):s[t]?(a.push(new RegExp(s[t])),null==l&&(l=a.length-1)):a.push(null)}),this.trigger("unmask").each(function(){function d(e){for(;++e<=f&&!a[e];);return e}function h(e){for(;--e>=0&&!a[e];);return e}function v(e,t){if(!(0>e)){for(var n=e,r=d(t);f>n;n++)if(a[n]){if(!(f>r&&a[n].test(c[r])))break;c[n]=c[r],c[r]=i.placeholder,r=d(r)}b(),o.caret(Math.max(l,e))}}function m(e){for(var t=e,n=i.placeholder;f>t;t++)if(a[t]){var r=d(t),o=c[t];if(c[t]=n,!(f>r&&a[r].test(o)))break;n=o}}function g(e){var t=e.which;if(8==t||46==t||n&&127==t){var r=o.caret(),i=r.begin,s=r.end;return s-i==0&&(i=46!=t?h(i):s=d(i-1),s=46==t?d(s):s),$(i,s),v(i,s-1),!1}return 27==t?(o.val(p),o.caret(0,w()),!1):void 0}function y(e){var t=e.which,n=o.caret();if(e.ctrlKey||e.altKey||e.metaKey||32>t)return!0;if(t){n.end-n.begin!=0&&($(n.begin,n.end),v(n.begin,n.end-1));var r=d(n.begin-1);if(f>r){var s=String.fromCharCode(t);if(a[r].test(s)){m(r),c[r]=s,b();var u=d(r);o.caret(u),i.completed&&u>=f&&i.completed.call(o)}}return!1}}function $(e,t){for(var n=e;t>n&&f>n;n++)a[n]&&(c[n]=i.placeholder)}function b(){return o.val(c.join("")).val()}function w(e){for(var t=o.val(),n=-1,r=0,s=0;f>r;r++)if(a[r]){for(c[r]=i.placeholder;s++<t.length;){var p=t.charAt(s-1);if(a[r].test(p)){c[r]=p,n=r;break}}if(s>t.length)break}else c[r]==t.charAt(s)&&r!=u&&(s++,n=r);return!e&&u>n+1?(o.val(""),$(0,f)):(e||n+1>=u)&&(b(),e||o.val(o.val().substring(0,n+1))),u?r:l}var o=e(this),c=e.map(r.split(""),function(e,t){return"?"!=e?s[e]?i.placeholder:e:void 0}),p=o.val();o.data(e.mask.dataName,function(){return e.map(c,function(e,t){return a[t]&&e!=i.placeholder?e:null}).join("")}),o.attr("readonly")||o.one("unmask",function(){o.unbind(".mask").removeData(e.mask.dataName)}).bind("focus.mask",function(){p=o.val();var t=w();b();var n=function(){t==r.length?o.caret(0,t):o.caret(t)};(e.browser.msie?n:function(){setTimeout(n,0)})()}).bind("blur.mask",function(){w(),o.val()!=p&&o.change()}).bind("keydown.mask",g).bind("keypress.mask",y).bind(t,function(){setTimeout(function(){o.caret(w(!0))},0)}),w()})}})}(jQuery);